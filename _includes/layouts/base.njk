<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} | {{ site.name }}</title>
    <meta name="description" content="{{ description or site.description }}">

    <!-- Canonical URL -->
    <link rel="canonical" href="{{ site.url }}{{ page.url }}">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ site.url }}{{ page.url }}">
    <meta property="og:title" content="{{ title }} | {{ site.name }}">
    <meta property="og:description" content="{{ description or site.description }}">
    <meta property="og:image" content="{{ site.url }}{{ image or site.image }}">
    <meta property="og:site_name" content="{{ site.name }}">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="{{ site.url }}{{ page.url }}">
    <meta name="twitter:title" content="{{ title }} | {{ site.name }}">
    <meta name="twitter:description" content="{{ description or site.description }}">
    <meta name="twitter:image" content="{{ site.url }}{{ image or site.image }}">

    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css" onerror="this.remove()">
    <script>
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
    </script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body{% if bodyClass %} class="{{ bodyClass }}"{% endif %}>
    {% include "components/header.njk" %}

    <main>
        {{ content | safe }}
    </main>

    {% include "components/footer.njk" %}
    
    <script src="/js/theme.js"></script>
    <script src="/js/nav.js"></script>
    <script src="/js/visitor-counter.js"></script>
    <script src="/pagefind/pagefind-ui.js" onerror="window.pagefindFailed=true"></script>
    <script>
      (function() {
        const searchToggle = document.getElementById('search-toggle');
        const searchDropdown = document.getElementById('search-dropdown');
        const searchContainer = document.querySelector('.search-container');
        const searchElement = document.getElementById('search');
        let pagefindUI = null;

        function openSearch() {
          if (!searchDropdown) return;
          searchDropdown.classList.add('is-open');

          if (!pagefindUI && typeof PagefindUI !== 'undefined') {
            pagefindUI = new PagefindUI({
              element: '#search',
              showSubResults: false,
              showImages: false
            });
          } else if (!pagefindUI && searchElement) {
            searchElement.innerHTML = '<p style="padding: 1rem; color: var(--text-muted); text-align: center; font-size: 0.875rem;">Search is currently unavailable.</p>';
          }

          setTimeout(() => {
            const input = searchDropdown.querySelector('input');
            if (input) input.focus();
          }, 100);
        }

        function closeSearch() {
          if (searchDropdown) searchDropdown.classList.remove('is-open');
        }

        function toggleSearch() {
          if (!searchDropdown) return;
          if (searchDropdown.classList.contains('is-open')) {
            closeSearch();
          } else {
            openSearch();
          }
        }

        if (searchToggle) searchToggle.addEventListener('click', toggleSearch);

        document.addEventListener('click', (e) => {
          if (searchContainer && !searchContainer.contains(e.target)) {
            closeSearch();
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeSearch();
          if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            toggleSearch();
          }
        });
      })();
    </script>
    <script>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", user => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              document.location.href = "/admin/";
            });
          }
        });
      }
    </script>
</body>
</html>