---
layout: layouts/base.njk
---

<article class="resume">
    <header class="resume-header">
        <h1>{{ name }}</h1>
        {% if subtitle %}
        <p class="resume-subtitle">{{ subtitle }}</p>
        {% endif %}
        <div class="contact-info">
            <p>{{ location }}{% if website %} | {{ website }}{% endif %}{% if github %} | {{ github }}{% endif %}</p>
            {% if contactNote %}<p class="contact-note" id="contact-note-link">{{ contactNote }}</p>{% endif %}
        </div>
        <button type="button" class="btn-download" id="download-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Download Resume
        </button>
    </header>

    <!-- Download Form Modal -->
    <div class="download-modal" id="download-modal">
        <div class="download-modal-content">
            <button type="button" class="modal-close" id="modal-close">&times;</button>
            <h3>Download Resume</h3>
            <p>Please provide your details to download the resume.</p>
            <form id="resume-download-form" action="https://resume-dl.nbadev01.workers.dev" method="POST">
                <div class="form-group">
                    <label for="download-name">Name</label>
                    <input type="text" id="download-name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="download-email">Email</label>
                    <input type="email" id="download-email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="download-company">Company (Optional)</label>
                    <input type="text" id="download-company" name="company">
                </div>
                <div class="form-group">
                    <div class="cf-turnstile" data-sitekey="0x4AAAAAACO5phJOlqGa3ZBx" data-theme="dark"></div>
                </div>
                <button type="submit" class="submit-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download PDF
                </button>
            </form>
            <div id="form-message" class="form-message"></div>
        </div>
    </div>

<script>
(function() {
  const btn = document.getElementById('download-btn');
  const modal = document.getElementById('download-modal');
  const closeBtn = document.getElementById('modal-close');
  const form = document.getElementById('resume-download-form');
  const message = document.getElementById('form-message');

  // Map backend error codes -> user-friendly messages
  const ERROR_MESSAGES = {
    INVALID_NAME_OR_EMAIL: 'Please enter a valid name and email address.',
    DISPOSABLE_EMAIL_BLOCKED: 'Please use a permanent email address. Temporary/disposable emails are not accepted.',
    TURNSTILE_TOKEN_MISSING: 'Please complete the security verification.',
    TURNSTILE_FAILED: 'Security verification failed. Please try again.',
    TURNSTILE_HTTP_ERROR: 'Security verification service is unavailable. Please try again later.',
    TURNSTILE_PARSE_ERROR: 'Unexpected response from security service. Please try again later.',
    TURNSTILE_HOST_MISMATCH: 'Security verification failed for this website. Please refresh the page and try again.',
    TURNSTILE_MISCONFIGURED: 'Security service is misconfigured. Please try again later.',
    RATE_LIMIT_EXCEEDED: 'Too many download attempts. Please wait a few minutes and try again.',
    PAYLOAD_TOO_LARGE: 'Your submission was too large. Please try again.',
    INVALID_CONTENT_TYPE: 'Unexpected request format. Please refresh the page and try again.',
    INVALID_JSON: 'Unexpected request data. Please refresh the page and try again.',
    SERVER_MISCONFIGURED: 'The server is misconfigured. Please try again later.',
    RELAY_FAILED: 'Unable to process your request right now. Please try again later.',
    ORIGIN_FORBIDDEN: 'This form can only be submitted from badev.net.',
    METHOD_NOT_ALLOWED: 'Unexpected request method. Please refresh the page and try again.'
  };

  function showMessage(text, type, code) {
    if (!message) return;
    message.textContent = text;
    message.className = 'form-message ' + (type === 'error' ? 'error' : 'success');

    if (code) {
      message.setAttribute('data-code', code);
    } else {
      message.removeAttribute('data-code');
    }
  }

  // Sync Turnstile theme with site theme
  function updateTurnstileTheme() {
    const turnstileEl = document.querySelector('.cf-turnstile');
    if (turnstileEl) {
      const theme = document.documentElement.getAttribute('data-theme') || 'dark';
      turnstileEl.setAttribute('data-theme', theme);
    }
  }
  updateTurnstileTheme();

  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.attributeName === 'data-theme') {
        updateTurnstileTheme();
        if (window.turnstile) {
          window.turnstile.reset();
        }
      }
    });
  });
  observer.observe(document.documentElement, { attributes: true });

  // Open modal
  btn.addEventListener('click', () => {
    modal.classList.add('is-open');
    document.body.classList.add('body--modal-open');
  });

  // Also open modal when clicking contact note
  const contactNote = document.getElementById('contact-note-link');
  if (contactNote) {
    contactNote.addEventListener('click', () => {
      modal.classList.add('is-open');
      document.body.classList.add('body--modal-open');
    });
  }

  // Close handlers
  closeBtn.addEventListener('click', () => {
    modal.classList.remove('is-open');
    document.body.classList.remove('body--modal-open');
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.remove('is-open');
      document.body.classList.remove('body--modal-open');
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Run built-in HTML5 validation
    if (!form.reportValidity()) {
      return;
    }

    const submitBtn = form.querySelector('button[type="submit"]');
    const token = window.turnstile ? window.turnstile.getResponse() : '';

    if (!token) {
      showMessage('Please complete the security verification.', 'error', 'TURNSTILE_TOKEN_MISSING');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';
    showMessage('', '', null); // clear
    message.style.display = 'block';

    try {
      const response = await fetch('https://resume-dl.nbadev01.workers.dev', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: form.name.value.trim(),
          email: form.email.value.trim(),
          company: form.company.value.trim() || 'Not provided',
          turnstileToken: token
        })
      });

      let data = null;
      try {
        data = await response.json();
      } catch (_) {
        // JSON parse failed, treat as a standardized error
        showMessage('Unexpected response from server. Please try again later.', 'error', 'INVALID_RESPONSE');
        return;
      }

      if (response.ok && data && data.success) {
        // ✅ Success path
        if (data.requiresVerification) {
          // Email verification required
          showMessage('Please check your email to verify your address. Click the link in the email to download the resume.', 'success', null);
          form.reset();
          if (window.turnstile) window.turnstile.reset();
          // Keep modal open so user sees the message
        } else if (data.downloadUrl) {
          // Direct download (legacy/fallback)
          showMessage('Thank you! Your download will start shortly.', 'success', null);
          setTimeout(() => {
            const downloadUrl = data.downloadUrl || '/files/Nikola_Badev_resume.pdf';
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = 'Nikola_Badev_resume.pdf';
            document.body.appendChild(link);
            link.click();
            link.remove();
            modal.classList.remove('is-open');
            form.reset();
            if (window.turnstile) window.turnstile.reset();
          }, 1500);
        } else {
          // Generic success
          showMessage('Thank you! Your request has been received.', 'success', null);
          form.reset();
          if (window.turnstile) window.turnstile.reset();
        }
      } else {
        // ❌ Error path with standardized codes
        const code = (data && data.code) || 'UNKNOWN_ERROR';
        const backendMessage = data && (data.message || data.error);
        const friendly =
          ERROR_MESSAGES[code] ||
          backendMessage ||
          'Something went wrong. Please try again later.';
        showMessage(friendly, 'error', code);
      }
    } catch (err) {
      showMessage('Network error. Please check your connection and try again.', 'error', 'NETWORK_ERROR');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML =
        '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Download PDF';
      if (window.turnstile) window.turnstile.reset();
    }
  });
})();
</script>
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

    {% if summary %}
    <section class="resume-section">
        <h2>Professional Summary</h2>
        <div class="summary-content">
            {{ summary | safe }}
        </div>
    </section>
    {% endif %}

    {% if skills %}
    <section class="resume-section">
        <h2>Core Technical Skills</h2>
        <div class="skills-list">
            {% for category in skills %}
            <div class="skill-category">
                <h3>{{ category.name }}</h3>
                <ul>
                    {% for item in category.items %}
                    <li>{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if experience %}
    <section class="resume-section">
        <h2>Professional Experience</h2>
        {% for job in experience %}
        <div class="job">
            <div class="job-header">
                <strong>{{ job.company }}</strong> – {{ job.location }}
            </div>
            <div class="job-title-date">
                <em>{{ job.title }}</em> | {{ job.startDate }} – {{ job.endDate or "Present" }}
            </div>
            <ul class="responsibilities">
                {% for item in job.responsibilities %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endfor %}
    </section>
    {% endif %}

    {% if projects %}
    <section class="resume-section">
        <h2>Home Lab & Projects</h2>
        {% for project in projects %}
        <div class="project-category">
            <h3>{{ project.name }}</h3>
            <ul>
                {% for item in project.items %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endfor %}
    </section>
    {% endif %}

    {% if education or certifications %}
    <section class="resume-section">
        <h2>Education & Certifications</h2>

        {% if certifications %}
        {% for cert in certifications %}
        <p>{{ cert.name }}{% if cert.issuer %} – {{ cert.issuer }}{% endif %}{% if cert.date %} – {{ cert.date }}{% endif %}</p>
        {% endfor %}
        {% endif %}

        {% if education %}
        {% for edu in education %}
        <p>{{ edu.degree }} – {{ edu.institution }}{% if edu.graduationDate %}, {{ edu.graduationDate }}{% endif %}</p>
        {% endfor %}
        {% endif %}
    </section>
    {% endif %}
</article>
