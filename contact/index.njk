---
layout: layouts/base.njk
title: Contact
description: Get in touch with me
bodyClass: contact-page
---

<section class="contact-hero">
    <h1>Get In Touch</h1>
    <p class="contact-intro">Have a question, opportunity, or just want to connect? Fill out the form below and I'll get back to you as soon as possible.</p>
</section>

<div class="contact-form">
    <form id="contact-form">
        <div class="form-row">
            <div class="form-group">
                <label for="contact-name">Name <span class="required">*</span></label>
                <input type="text" id="contact-name" name="name" required autocomplete="name" placeholder="Your name">
            </div>
            <div class="form-group">
                <label for="contact-email">Email <span class="required">*</span></label>
                <input type="email" id="contact-email" name="email" required autocomplete="email" placeholder="your@email.com">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="contact-company">Company <span class="optional">(Optional)</span></label>
                <input type="text" id="contact-company" name="company" autocomplete="organization" placeholder="Your company">
            </div>
            <div class="form-group">
                <label for="contact-subject">Subject <span class="required">*</span></label>
                <input type="text" id="contact-subject" name="subject" required placeholder="What's this about?">
            </div>
        </div>

        <div class="form-group">
            <label for="contact-message">Message <span class="required">*</span></label>
            <textarea id="contact-message" name="message" rows="6" required placeholder="Your message..."></textarea>
        </div>

        <div class="form-group turnstile-container">
            <div class="cf-turnstile" data-sitekey="{{ env.turnstileSiteKey }}" data-theme="dark"></div>
        </div>

        <button type="submit" class="submit-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
            Send Message
        </button>
    </form>

    <div id="contact-status" class="form-message" style="display: none;"></div>
</div>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<script>
(function() {
  const form = document.getElementById('contact-form');
  const status = document.getElementById('contact-status');
  const submitBtn = form ? form.querySelector('button[type="submit"]') : null;
  const originalBtnHTML = submitBtn ? submitBtn.innerHTML : '';

  // Map backend error codes -> user-friendly messages
  const ERROR_MESSAGES = {
    INVALID_NAME_OR_EMAIL: 'Please enter a valid name and email address.',
    DISPOSABLE_EMAIL_BLOCKED: 'Please use a permanent email address. Temporary/disposable emails are not accepted.',
    SUBJECT_MESSAGE_REQUIRED: 'Please provide both a subject and a message.',
    TURNSTILE_TOKEN_MISSING: 'Please complete the security verification.',
    TURNSTILE_FAILED: 'Security verification failed. Please try again.',
    TURNSTILE_HTTP_ERROR: 'Security verification service is unavailable. Please try again later.',
    TURNSTILE_PARSE_ERROR: 'Unexpected response from security service. Please try again later.',
    TURNSTILE_HOST_MISMATCH: 'Security verification failed for this website. Please refresh the page and try again.',
    TURNSTILE_MISCONFIGURED: 'Security service is misconfigured. Please try again later.',
    RATE_LIMIT_EXCEEDED: 'Too many messages in a short time. Please wait a few minutes and try again.',
    PAYLOAD_TOO_LARGE: 'Your message was too large. Please shorten it and try again.',
    INVALID_CONTENT_TYPE: 'Unexpected request format. Please refresh the page and try again.',
    INVALID_JSON: 'Unexpected request data. Please refresh the page and try again.',
    SERVER_MISCONFIGURED: 'The server is misconfigured. Please try again later.',
    RELAY_FAILED: 'Unable to send your message right now. Please try again later.',
    ORIGIN_FORBIDDEN: 'This form can only be submitted from badev.net.',
    METHOD_NOT_ALLOWED: 'Unexpected request method. Please refresh the page and try again.'
  };

  function showStatus(text, type, code) {
    if (!status) return;
    status.textContent = text;
    status.className = 'form-message ' + (type === 'error' ? 'error' : 'success');
    status.style.display = 'block';

    if (code) {
      status.setAttribute('data-code', code);
    } else {
      status.removeAttribute('data-code');
    }
  }

  // Update Turnstile theme based on current theme
  function updateTurnstileTheme() {
    const turnstileEl = document.querySelector('.cf-turnstile');
    if (turnstileEl) {
      const theme = document.documentElement.getAttribute('data-theme') || 'dark';
      turnstileEl.setAttribute('data-theme', theme);
    }
  }
  updateTurnstileTheme();

  // Watch for theme changes
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.attributeName === 'data-theme') {
        updateTurnstileTheme();
        if (window.turnstile) {
          window.turnstile.reset();
        }
      }
    });
  });
  observer.observe(document.documentElement, { attributes: true });

  if (form) {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      // Run browser validation (required, type=email, etc.)
      if (!form.reportValidity()) {
        return;
      }

      const token = window.turnstile ? window.turnstile.getResponse() : '';

      if (!token) {
        showStatus('Please complete the security verification.', 'error', 'TURNSTILE_TOKEN_MISSING');
        return;
      }

      // Disable button and show loading
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading-spinner"></span> Sending...';
      status.style.display = 'none';
      status.removeAttribute('data-code');

      try {
        const response = await fetch('https://contact-form.nbadev01.workers.dev', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: 'contact',
            name: form.name.value.trim(),
            email: form.email.value.trim(),
            company: form.company.value.trim() || null,
            subject: form.subject.value.trim(),
            message: form.message.value.trim(),
            turnstileToken: token
          })
        });

        let data = null;
        try {
          data = await response.json();
        } catch (_) {
          // JSON parse failed; treat as generic error with its own code
          showStatus('Unexpected response from server. Please try again later.', 'error', 'INVALID_RESPONSE');
          return;
        }

        if (response.ok && data && data.success) {
          if (data.requiresVerification) {
            // Email verification required
            showStatus(
              'Please check your email to verify your address. Click the link in the email to send your message.',
              'success',
              null
            );
          } else {
            // Direct success (legacy/fallback)
            showStatus(
              'Thank you! Your message has been sent successfully. I\'ll get back to you soon.',
              'success',
              null
            );
          }
          form.reset();
          if (window.turnstile) window.turnstile.reset();
        } else {
          const code = (data && data.code) || 'UNKNOWN_ERROR';
          const backendMessage = data && (data.message || data.error);
          const friendly =
            ERROR_MESSAGES[code] ||
            backendMessage ||
            'Something went wrong. Please try again later.';
          showStatus(friendly, 'error', code);
        }
      } catch (err) {
        showStatus('Network error. Please check your connection and try again.', 'error', 'NETWORK_ERROR');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnHTML;
        if (window.turnstile) window.turnstile.reset();
      }
    });
  }
})();
</script>

<p class="visitor-counter loading">
    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
        <circle cx="12" cy="12" r="3"></circle>
    </svg>
    <span class="visitor-count">...</span> visitors
</p>
